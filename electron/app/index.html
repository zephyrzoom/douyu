<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>707弹幕助手</title>
        <link rel="stylesheet" href="../css/index.css">
        <!-- Stylesheets -->
        <link rel="stylesheet" href="../css/photon.min.css">
        <!-- Jquery -->
        <script>window.$ = window.jQuery = require('../js/jquery.js')</script>

    </head>
    <body>
        <script>
        /*
         * 弹幕程序
         */
        var http = require('http');
        var net = require('net');

        function start(roomid) {
          // 建立socket连接
          var s = net.connect({
            port:8601,
            host:'openbarrage.douyutv.com'
          }, function() {
            console.log('connect success');
          });

          var msg = 'type@=loginreq/roomid@=' + roomid + '/';
          sendData(s, msg);

          // 接收数据
          s.on('data', function(chunk) {
            formatData(chunk);
            var msg = 'type@=joingroup/rid@=' + roomid + '/gid@=-9999/';
            sendData(s, msg);
          });

          // 设置心跳
          setInterval(function() {
            var timestamp = parseInt(new Date()/1000);
            var msg = 'type@=keeplive/tick@=' + timestamp + '/';
            sendData(s, msg);
          }, 45000);

        }

        // 给弹幕服务器发送消息
        function sendData(s, msg) {
          var data = new Buffer(msg.length + 13);
          data.writeInt32LE(msg.length + 9, 0);
          data.writeInt32LE(msg.length + 9, 4);
          data.writeInt32LE(689, 8);
          data.write(msg + '\0', 12);
          s.write(data);
        }

        // 格式化数据
        function formatData(msg) {
          var sliced = msg.slice(12).toString();
          var splited = sliced.substring(0, sliced.length - 2).split('/');
          var map = formatDanmu(splited);
          analyseDanmu(map);
        }

        // 格式化收到的弹幕，存入map
        function formatDanmu(msg) {
          var map = {};
          for (var i in msg) {
            var splited = msg[i].split('@=');
            map[splited[0]] = splited[1];
          }
          return map;
        }

        // 识别弹幕信息
        function analyseDanmu(msg) {
          if (msg['type'] == 'chatmsg') {
            updateMsg(msg['nn'], msg['txt']);
          }
        }

        // 更新页面数据
        function updateMsg(nn, txt) {
          var content = document.getElementById('messages');
          content.innerHTML += '<tr><td><span class="uname">' + nn + '</span>:' + txt + '</td></tr>';
          // 滚动条始终在最下面
          var pane = document.getElementById('pane');
          pane.scrollTop = pane.scrollHeight;
        }

        // 设置房间号
        function setRoomId() {
          var roomid = document.getElementById('roomid').value;
          var content = document.getElementById('pane');
          content.innerHTML = "<table class='table-striped'><tbody id='messages'></tbody></table>";
          start(roomid);

          const {ipcRenderer} = require('electron');
          ipcRenderer.send('asynchronous-message', 'ping');
        }

        $(document).ready(function () {
          const {shell} = require('electron');
          const githubLink = document.getElementById('github');
          githubLink.addEventListener('click', function (event) {
            shell.openExternal('http://github.com/zephyrzoom');
          });
        });


        </script>
        <div class="window">
          <div class="window-content">
            <div class="pane-group">
              <div class="pane" id="pane">
                <from>
                  <div class="form-group">
                    <h5>请输入房间号</h5>
                    <input type="text" class="form-control" placeholder="房间号" id="roomid" maxlength="10">
                    <button onclick="setRoomId()" class="btn btn-primary btn-large">连接</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
          <footer class="toolbar toolbar-footer">
            <h1 class="title"><a id="github"><span class="icon icon-github"></span></a></h1>
          </footer>
        </div>
    </body>
</html>
